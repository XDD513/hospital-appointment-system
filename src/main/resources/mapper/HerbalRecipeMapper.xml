<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.mapper.HerbalRecipeMapper">

    <!-- ResultMap 定义 -->
    <resultMap id="HerbalRecipeResultMap" type="com.hospital.entity.HerbalRecipe">
        <id property="id" column="id"/>
        <result property="recipeName" column="recipe_name"/>
        <result property="constitutionType" column="constitution_type"/>
        <result property="season" column="season"/>
        <result property="category" column="category"/>
        <result property="difficulty" column="difficulty"/>
        <result property="cookingTime" column="cooking_time"/>
        <result property="servings" column="servings"/>
        <result property="ingredients" column="ingredients"/>
        <result property="steps" column="steps"/>
        <result property="efficacy" column="efficacy"/>
        <result property="suitableSymptoms" column="suitable_symptoms"/>
        <result property="contraindications" column="contraindications"/>
        <result property="nutritionInfo" column="nutrition_info"/>
        <result property="tips" column="tips"/>
        <result property="image" column="image"/>
        <result property="videoUrl" column="video_url"/>
        <result property="viewCount" column="view_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="status" column="status"/>
        <result property="version" column="version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 根据体质类型推荐药膳（分页） -->
    <select id="selectRecommendedRecipes" resultMap="HerbalRecipeResultMap">
        SELECT * FROM herbal_recipe
        WHERE status = 1
        AND (constitution_type LIKE CONCAT('%', #{constitutionType}, '%') OR constitution_type = 'ALL')
        <if test="season != null and season != ''">
            AND (season LIKE CONCAT('%', #{season}, '%') OR season = 'ALL')
        </if>
        ORDER BY favorite_count DESC, view_count DESC
    </select>

    <!-- 获取全部药膳列表（分页，不包含AI推荐） -->
    <select id="selectAllRecipes" resultMap="HerbalRecipeResultMap">
        SELECT * FROM herbal_recipe
        WHERE status = 1
        ORDER BY view_count DESC, favorite_count DESC
    </select>

    <!-- 搜索药膳（支持关键词、季节、体质、功效筛选） -->
    <select id="searchRecipes" resultMap="HerbalRecipeResultMap">
        SELECT * FROM herbal_recipe
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            AND (
                recipe_name LIKE CONCAT('%', #{keyword}, '%')
                OR efficacy LIKE CONCAT('%', #{keyword}, '%')
                OR suitable_symptoms LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="season != null and season != ''">
            AND (season LIKE CONCAT('%', #{season}, '%') OR season = 'ALL')
        </if>
        <if test="constitutionType != null and constitutionType != ''">
            AND (constitution_type LIKE CONCAT('%', #{constitutionType}, '%') OR constitution_type = 'ALL')
        </if>
        <if test="effect != null and effect != ''">
            AND efficacy LIKE CONCAT('%', #{effect}, '%')
        </if>
        ORDER BY view_count DESC
    </select>

    <!-- 获取热门药膳 -->
    <select id="selectPopularRecipes" resultMap="HerbalRecipeResultMap">
        SELECT * FROM herbal_recipe
        WHERE status = 1
        ORDER BY view_count DESC, favorite_count DESC
        LIMIT #{limit}
    </select>

    <!-- 获取时令药膳 -->
    <select id="selectSeasonalRecipes" resultMap="HerbalRecipeResultMap">
        SELECT * FROM herbal_recipe
        WHERE status = 1
        AND (season LIKE CONCAT('%', #{season}, '%') OR season = 'ALL')
        ORDER BY favorite_count DESC
        LIMIT #{limit}
    </select>

    <!-- 增加浏览次数 -->
    <update id="incrementViewCount">
        UPDATE herbal_recipe
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>

    <!-- 增加收藏次数 -->
    <update id="incrementFavoriteCount">
        UPDATE herbal_recipe
        SET favorite_count = favorite_count + 1
        WHERE id = #{id}
    </update>

    <!-- 减少收藏次数 -->
    <update id="decrementFavoriteCount">
        UPDATE herbal_recipe
        SET favorite_count = favorite_count - 1
        WHERE id = #{id} AND favorite_count > 0
    </update>

    <!-- 获取活跃药膳用于推荐 -->
    <select id="selectActiveRecipesForRecommendation" resultMap="HerbalRecipeResultMap">
        SELECT *
        FROM herbal_recipe
        WHERE status = 1
        ORDER BY favorite_count DESC, view_count DESC, updated_at DESC
        LIMIT #{limit}
    </select>

    <!-- 根据ID集合查询有效药膳 -->
    <select id="selectActiveRecipesByIds" resultMap="HerbalRecipeResultMap">
        SELECT *
        FROM herbal_recipe
        WHERE status = 1
        AND id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

</mapper>

